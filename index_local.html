<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bergson and Friends - Local Test</title>
<link rel="stylesheet" href="static/style.css">
<link rel="stylesheet" href="static/responsive.css" media="screen and (max-width: 768px)">
</head>
<body>
  <div class="desktop-version">
<header> <img src="static/img/BergsonAndFriendsLOGO.png"> </header>
<main>
  <section class="philosophers">

    <!-- Philosophe 1 : Spinoza (seul actif pour test) -->
    <article class="philosopher" id="spinoza">
      <button class="philosopher-trigger">
      <h2>Baruch <span>Spinoza</span></h2>
      <img src="static/img/Spinoza.png" alt="Baruch Spinoza"> </button>
      <div class="dialogue" hidden>
        <div class="qa-history"></div>
        <form class="qa-form">
          <textarea id="question-spinoza" name="question" placeholder="Pose une question Ã  Spinoza..."></textarea>
          <input type="image" src="static/img/Submit.png" alt="envoyer">
        </form>
      </div>
    </article>

  </section>
</main>
</div>

<script>
// Configuration locale : API FastAPI sur localhost:7860
const API_BASE_URL = 'http://localhost:7860';

// Gestion interaction philosophe
const article = document.getElementById('spinoza');
const trigger = article.querySelector('.philosopher-trigger');
const dialogue = article.querySelector('.dialogue');
const form = article.querySelector('.qa-form');
const textarea = article.querySelector('textarea');
const history = article.querySelector('.qa-history');

let conversationHistory = [];

// Au clic sur le philosophe, initialiser
trigger.addEventListener('click', async () => {
  dialogue.hidden = !dialogue.hidden;

  // Si premiÃ¨re ouverture, appeler /init
  if (!conversationHistory.length && !dialogue.hidden) {
    try {
      const response = await fetch(`${API_BASE_URL}/init/spinoza`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await response.json();
      console.log('[INIT]', data);

      // Afficher le greeting
      conversationHistory = data.history;
      renderHistory();

    } catch (error) {
      console.error('[INIT ERROR]', error);
      alert(`Erreur init: ${error.message}\n\nVÃ©rifie que le backend tourne sur ${API_BASE_URL}`);
    }
  }
});

// Soumission question
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const userMessage = textarea.value.trim();
  if (!userMessage) return;

  // DÃ©sactiver pendant traitement
  textarea.disabled = true;
  const submitBtn = form.querySelector('input[type="image"]');
  submitBtn.style.opacity = '0.5';

  try {
    const response = await fetch(`${API_BASE_URL}/chat/spinoza`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: userMessage,
        history: conversationHistory,
        philosopher: 'spinoza'
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('[CHAT]', data);

    // Mettre Ã  jour historique
    conversationHistory = data.history;
    renderHistory();

    // Afficher passages RAG en console
    if (data.rag_passages && data.rag_passages.length) {
      console.log('[RAG PASSAGES]', data.rag_passages);
    }

    // RÃ©initialiser textarea
    textarea.value = '';

  } catch (error) {
    console.error('[CHAT ERROR]', error);
    alert(`Erreur chat: ${error.message}\n\nVÃ©rifie que le backend tourne sur ${API_BASE_URL}`);
  } finally {
    textarea.disabled = false;
    submitBtn.style.opacity = '1';
    textarea.focus();
  }
});

// Rendu historique
function renderHistory() {
  history.innerHTML = '';

  for (const [userMsg, assistantMsg] of conversationHistory) {
    // Message utilisateur
    if (userMsg) {
      const userDiv = document.createElement('div');
      userDiv.className = 'user-message';
      userDiv.style.cssText = 'margin: 1em 0; padding: 0.5em; background: #f0f0f0; border-radius: 8px;';
      userDiv.textContent = `Vous : ${userMsg}`;
      history.appendChild(userDiv);
    }

    // Message assistant
    if (assistantMsg) {
      const assistantDiv = document.createElement('div');
      assistantDiv.className = 'assistant-message';
      assistantDiv.style.cssText = 'margin: 1em 0; padding: 0.5em; background: #e8f4f8; border-radius: 8px;';
      assistantDiv.textContent = `Spinoza : ${assistantMsg}`;
      history.appendChild(assistantDiv);
    }
  }

  // Scroll vers le bas
  history.scrollTop = history.scrollHeight;
}

console.log('âœ… Interface locale chargÃ©e');
console.log(`ðŸ“¡ API Backend: ${API_BASE_URL}`);
console.log('ðŸ’¡ Cliquez sur Spinoza pour dÃ©marrer');
</script>

</body>
</html>
